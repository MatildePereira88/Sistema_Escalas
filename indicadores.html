<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Indicadores - Sistema de Escalas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        :root {
            --cor-fundo: #f4f7f6;
            --cor-card-fundo: #ffffff;
            --cor-texto-primario: #1a202c;
            --cor-texto-secundario: #718096;
            --cor-borda: #e2e8f0;
            --cor-header-fundo: #1a202c;
            --cor-header-texto: #f7fafc;
            --cor-header-borda: #2d3748;
            --cor-primaria: #000000;
            --cor-secundaria: #D4B344;
            --cor-alerta-vermelho: #e53e3e;
            --cor-alerta-amarelo: #dd6b20;
            --cor-azul-grafico: #4299e1;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--cor-fundo); color: var(--cor-texto-primario); margin: 0; }
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        .card { background-color: var(--cor-card-fundo); padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); border: 1px solid var(--cor-borda); }
        .section-title { font-size: 1.5em; color: var(--cor-texto-primario); border-bottom: 1px solid var(--cor-borda); padding-bottom: 10px; margin-top: 40px; margin-bottom: 20px; font-weight: 600; }
        #loading-stats { padding: 30px; text-align: center; color: var(--cor-texto-secundario); font-size: 1.1em; }
        .main-header { background-color: var(--cor-header-fundo); padding: 10px 30px; }
        .main-header .header-content { display: flex; align-items: center; justify-content: space-between; max-width: 1400px; margin: 0 auto; }
        .main-header .header-title-group { display: flex; align-items: center; gap: 15px; }
        .main-header .logo { height: 40px; }
        .main-header h1 { color: var(--cor-header-texto); font-size: 1.4em; }
        .btn-voltar-header { display: inline-block; padding: 8px 18px; background-color: transparent; color: #9ca3af; text-decoration: none; font-weight: 500; border-radius: 6px; border: 1px solid var(--cor-header-borda); transition: all 0.2s; }
        .btn-voltar-header:hover { background-color: var(--cor-secundaria); color: var(--cor-primaria); border-color: var(--cor-secundaria); }
        .filters-container { display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end; }
        .filter-group { flex: 1; min-width: 160px; }
        .filter-group label { font-size: 0.8em; font-weight: 600; color: var(--cor-texto-secundario); display: block; margin-bottom: 4px; }
        .filter-group input, .filter-group select { width: 100%; box-sizing: border-box; padding: 10px; border-radius: 6px; border: 1px solid var(--cor-borda); }
        .filters-container button { padding: 10px 25px; border-radius: 6px; border: none; background-color: var(--cor-secundaria); color: var(--cor-primaria); cursor: pointer; font-weight: 600; height: 42px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .kpi-card { padding: 20px; text-align: center; }
        .kpi-value { font-size: 2.5em; font-weight: 700; color: var(--cor-azul-grafico); }
        .kpi-label { font-size: 0.9em; color: var(--cor-texto-secundario); margin-top: 5px; }
        .analysis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px; }
        .analysis-grid.single-col { grid-template-columns: 1fr; }
        .chart-card, .table-card { display: flex; flex-direction: column; }
        .chart-card h3, .table-card h3 { margin-top: 0; font-size: 1.1em; display: flex; align-items: center; gap: 10px; }
        .alert-dot { height: 10px; width: 10px; border-radius: 50%; flex-shrink: 0; }
        .alert-dot.red { background-color: var(--cor-alerta-vermelho); }
        .alert-dot.yellow { background-color: var(--cor-alerta-amarelo); }
        .table-wrapper { flex-grow: 1; overflow-y: auto; }
        .table-wrapper.no-limit { max-height: none; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 10px; text-align: left; border-bottom: 1px solid var(--cor-borda); }
        .data-table thead th { background-color: #f9fafb; position: sticky; top: 0; font-size: 0.9em; }
        .drill-down-action { color: var(--cor-azul-grafico); text-decoration: underline; cursor: pointer; font-weight: 600; }
        .chart-wrapper { position: relative; flex-grow: 1; min-height: 350px; }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-content">
            <div class="header-title-group">
                <img src="assets/img/logo.png" alt="Logo da Empresa" class="logo">
                <h1>Dashboard Estratégico</h1>
            </div>
            <a href="/painel-adm.html" class="btn-voltar-header">Voltar ao Painel</a>
        </div>
    </header>

    <main class="container">
        <div class="filters-container card">
            <div class="filter-group"><label for="filtro-data-inicio">Analisar Período De</label><input type="date" id="filtro-data-inicio"></div>
            <div class="filter-group"><label for="filtro-data-fim">Até</label><input type="date" id="filtro-data-fim"></div>
            <div class="filter-group"><label for="filtro-loja">Loja</label><select id="filtro-loja"><option value="">Todas</option></select></div>
            <div class="filter-group" id="container-filtro-supervisor"><label for="filtro-supervisor">Supervisor</label><select id="filtro-supervisor"><option value="">Todos</option></select></div>
            <button id="btn-aplicar-filtros">Analisar</button>
        </div>

        <div id="loading-stats">Selecione um período para iniciar a análise...</div>

        <div id="stats-wrapper" style="display: none;">
            <h2 class="section-title">Saúde Organizacional</h2>
            <div class="kpi-grid">
                <div class="kpi-card"><div class="kpi-value" id="kpi-total-colaboradores">0</div><div class="kpi-label">Colaboradores na Análise</div></div>
                <div class="kpi-card"><div class="kpi-value" id="kpi-total-lojas">0</div><div class="kpi-label">Lojas na Análise</div></div>
                <div class="kpi-card"><div class="kpi-value" id="kpi-media-colabs-loja">0</div><div class="kpi-label">Média de Colab. por Loja</div></div>
                <div class="kpi-card"><div class="kpi-value" id="kpi-taxa-absenteismo">0%</div><div class="kpi-label">Taxa de Absenteísmo</div></div>
            </div>
            <div class="analysis-grid single-col">
                 <div class="chart-card"><h3>Composição da Equipa por Cargo</h3><div class="chart-wrapper"><canvas id="grafico-cargos"></canvas></div></div>
                 <div class="chart-card"><h3>Ranking de Lojas por Absenteísmo (%)</h3><div class="chart-wrapper"><canvas id="grafico-ranking-absenteismo"></canvas></div></div>
            </div>

            <h2 class="section-title">Eficiência Operacional</h2>
             <div class="analysis-grid single-col">
                <div class="chart-card"><h3>Alocação de Dias no Período</h3><div class="chart-wrapper"><canvas id="grafico-alocacao-trabalho"></canvas></div></div>
             </div>
            
            <h2 class="section-title">Painel de Ação e Risco</h2>
            <div class="analysis-grid">
                 <div class="table-card">
                     <h3><span class="alert-dot red"></span>Escalas Pendentes de Registo</h3>
                     <div class="table-wrapper no-limit"><table class="data-table"><thead><tr><th>Loja</th><th>Período Pendente</th></tr></thead><tbody id="tabela-escalas-faltantes"></tbody></table></div>
                 </div>
                 <div class="table-card">
                     <h3><span class="alert-dot yellow"></span>Alertas de Cobertura de Liderança</h3>
                     <div class="table-wrapper no-limit">
                        <table class="data-table">
                            <thead><tr><th>Data do Alerta</th><th>Detalhe do Risco</th><th>Ação</th></tr></thead>
                            <tbody id="tabela-alertas-lideranca"></tbody>
                        </table>
                    </div>
                 </div>
            </div>
        </div>
    </main>

    <script src="assets/js/modal.js"></script>
    <script>
        // Todo o JavaScript que estava em 'indicadores.js' está agora aqui dentro.
        let graficoCargos, graficoRanking, graficoAlocacao;

        Chart.register(ChartDataLabels);
        Chart.defaults.font.family = 'Inter, sans-serif';
        Chart.defaults.plugins.datalabels.font.weight = 'bold';
        Chart.defaults.plugins.datalabels.formatter = (value) => value > 0 ? value : '';

        document.addEventListener('DOMContentLoaded', () => {
            const usuarioLogado = JSON.parse(sessionStorage.getItem('usuarioLogado'));
            if (!usuarioLogado || !['Administrador', 'Supervisor'].includes(usuarioLogado.nivel_acesso)) {
                showCustomModal('Você não tem permissão para acessar esta página.', { title: 'Acesso Negado', type: 'error', onConfirm: () => { window.location.href = 'visualizar_escalas.html'; } });
                document.querySelector('main')?.remove(); return;
            }
            configurarVisaoPorPerfil(usuarioLogado);
            carregarFiltros(usuarioLogado);
            document.getElementById('btn-aplicar-filtros').addEventListener('click', carregarEstatisticas);
        });

        function configurarVisaoPorPerfil(usuario) {
            if (usuario.nivel_acesso === 'Supervisor') {
                document.getElementById('container-filtro-supervisor').style.display = 'none';
            }
        }

        async function carregarFiltros(usuario) {
            try {
                const [resLojas, resSupervisores] = await Promise.all([ fetch('/.netlify/functions/getLojas'), fetch('/.netlify/functions/getSupervisores') ]);
                if (!resLojas.ok || !resSupervisores.ok) throw new Error("Falha ao carregar dados para os filtros.");
                let lojas = await resLojas.json();
                const supervisores = await resSupervisores.json();
                if (usuario.nivel_acesso === 'Supervisor') {
                    lojas = lojas.filter(loja => loja.supervisorId === usuario.userId);
                }
                const selectLoja = document.getElementById('filtro-loja');
                selectLoja.innerHTML = '<option value="">Todas</option>';
                lojas.forEach(loja => selectLoja.add(new Option(loja.nome, loja.id)));
                const selectSupervisor = document.getElementById('filtro-supervisor');
                selectSupervisor.innerHTML = '<option value="">Todos</option>';
                supervisores.forEach(sup => selectSupervisor.add(new Option(sup.nome, sup.id)));
            } catch (error) { 
                document.getElementById('loading-stats').textContent = 'Erro ao carregar os filtros da página.';
            }
        }

        async function carregarEstatisticas() {
            const loadingDiv = document.getElementById('loading-stats');
            const statsWrapper = document.getElementById('stats-wrapper');
            loadingDiv.textContent = 'Analisando dados, por favor aguarde...';
            loadingDiv.style.display = 'block';
            statsWrapper.style.display = 'none';

            const dataInicio = document.getElementById('filtro-data-inicio').value;
            const dataFim = document.getElementById('filtro-data-fim').value;
            if (!dataInicio || !dataFim) {
                loadingDiv.textContent = 'Por favor, selecione um período de início e fim para a análise.';
                return;
            }
            const supervisorId = (JSON.parse(sessionStorage.getItem('usuarioLogado')).nivel_acesso === 'Supervisor') 
                ? JSON.parse(sessionStorage.getItem('usuarioLogado')).userId 
                : document.getElementById('filtro-supervisor').value;
            const params = new URLSearchParams({
                data_inicio: dataInicio, data_fim: dataFim,
                lojaId: document.getElementById('filtro-loja').value, supervisorId: supervisorId,
            }).toString();

            try {
                const response = await fetch(`/.netlify/functions/getStats?${params}`);
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Falha ao buscar dados dos indicadores.');

                document.getElementById('kpi-total-colaboradores').textContent = result.totalColaboradores;
                document.getElementById('kpi-total-lojas').textContent = result.totalLojas;
                document.getElementById('kpi-media-colabs-loja').textContent = result.mediaColabsLoja;
                document.getElementById('kpi-taxa-absenteismo').textContent = result.taxaAbsenteismo;

                renderizarGrafico('grafico-cargos', 'graficoCargos', 'doughnut', result.distribuicaoCargos, 'Cargos');
                renderizarGrafico('grafico-ranking-absenteismo', 'graficoRanking', 'bar', result.rankingAbsenteismo, '% Atestados', { indexAxis: 'y' });
                renderizarGrafico('grafico-alocacao-trabalho', 'graficoAlocacao', 'pie', result.alocacaoTrabalho, 'Alocação de Dias');
                
                renderizarTabela('tabela-escalas-faltantes', result.escalasFaltantes, ["Loja", "Período Pendente"], item => `<td>${item.lojaNome}</td><td>${item.periodo}</td>`);
                renderizarTabelaAlertas(result.alertasLideranca);

                loadingDiv.style.display = 'none';
                statsWrapper.style.display = 'block';
            } catch (error) {
                loadingDiv.textContent = `Erro ao carregar indicadores: ${error.message}`;
            }
        }

        function renderizarGrafico(canvasId, chartVar, type, dados, label, extraOptions = {}) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (window[chartVar]) window[chartVar].destroy();

            const options = {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: !extraOptions.indexAxis && type !== 'bar', position: 'top', labels: { color: '#333' } },
                    datalabels: {
                        color: (type === 'doughnut' || type === 'pie') ? '#fff' : '#6b7280',
                        formatter: (value, context) => (extraOptions.indexAxis === 'y' ? value.toFixed(1) + '%' : value)
                    }
                },
                scales: (type === 'bar') ? {
                    y: { ticks: { color: '#6b7280' }, grid: { display: false } }, 
                    x: { ticks: { color: '#6b7280' } }
                } : {},
                ...extraOptions
            };

            window[chartVar] = new Chart(ctx, {
                type, data: { labels: Object.keys(dados), datasets: [{ label, data: Object.values(dados), backgroundColor: ['#2563eb', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6', '#6b7280'] }] },
                options
            });
        }

        function renderizarTabela(tbodyId, itens, headers, rowRenderer) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = '';
            if (!itens || itens.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${headers.length}" style="text-align: center; padding: 20px;">Nenhum item encontrado.</td></tr>`;
                return;
            }
            itens.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = rowRenderer(item);
            });
        }

        function renderizarTabelaAlertas(itens) {
            const tbody = document.getElementById('tabela-alertas-lideranca');
            tbody.innerHTML = '';
            if (!itens || itens.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 20px;">Nenhum alerta de cobertura encontrado.</td></tr>`;
                return;
            }
            itens.forEach((item, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.data.split('-').reverse().join('/')}</td>
                    <td>${item.detalhe}</td>
                    <td><span class="drill-down-action" data-index="${index}">Detalhes</span></td>
                `;
            });

            tbody.querySelectorAll('.drill-down-action').forEach(action => {
                action.addEventListener('click', (e) => {
                    const index = e.target.dataset.index;
                    const alerta = itens[index];
                    let detalhesHTML = '<ul style="list-style: none; padding: 0; text-align: left;">';
                    alerta.ausentes.forEach(gerente => {
                        detalhesHTML += `<li style="margin-bottom: 5px;"><strong>${gerente.nome}</strong> (${gerente.loja}) - Status: ${gerente.status}</li>`;
                    });
                    detalhesHTML += '</ul>';
                    showCustomModal(detalhesHTML, {
                        title: `Detalhes do Alerta de ${alerta.data.split('-').reverse().join('/')}`,
                        isHtml: true
                    });
                });
            });
        }
    </script>
</body>
</html>
